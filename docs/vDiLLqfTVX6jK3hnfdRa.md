---
title: Debugging AutoSync
---

<div align="center">    <br/>    <div>DOC</div>    <h1>Debugging AutoSync</h1>    <br/>  </div>

### Files Used:
ðŸ“„ src/swimmagic/applicability.spec.ts

ðŸ“„ src/swimmagic/autofix.spec.ts


<br/>

So let's say you get one of these tickets to tackle - where `verify` says the Unit is `verified`, but the UI says all snippets are `autosyncable`. Or vice versa. Or any other weird issue coming up with `AutoSync`. What do you do?

This document includes some tips and best practices.

# Prerequisites.
* A deep understanding of AutoSync's main flow (**TBD - link**).

# General things
* Go through `swimm log` and see if you get helpful hints.

# How to investigate?
A good start is to ask yourself what you would expect.

Open the `.swm` file, look at the actual snippets. 

Then, look at their current state in the code.

Also, understand AutoSync's starting point (**TBD - link**). Does it start from a specific commit deduced from the Blob Sha? The `swimm log` should help with that.



<br/>

# Applicability


<br/>

`validateApplicabilityStatuses` checks the applicability of the entire patch as well as hunk by hunk. It may give hints to see the different results.
Running an applicability test that calls this function can be helpful.

<div>    ðŸ“„ src/swimmagic/applicability.spec.ts  </div>

```ts
â¬œ 40      * Validates units applicability statuses
â¬œ 41      * @param ignoredSwmsList - ids of invalid/inapplicable swms that should be ignored when validating the applicabilities
â¬œ 42      */
ðŸŸ© 43     async function validateApplicabilityStatuses({ ignoredSwmsList }: { ignoredSwmsList: string[] }) {
ðŸŸ© 44       const swmsList = await getListOfSwmFilesInRepo();
ðŸŸ© 45       for (const swm of swmsList) {
ðŸŸ© 46         if (ignoredSwmsList.includes(swm)) {
ðŸŸ© 47           continue;
ðŸŸ© 48         }
ðŸŸ© 49         const autoFixResult = await autofix.autoFixUnit(swm);
ðŸŸ© 50         const applicabilityResults = await checkApplicabilityForSwmFile(autoFixResult.autoFixedSwmFile);
ðŸŸ© 51         try {
ðŸŸ© 52           expect(applicabilityResults.hunkByHunkApplicability).toEqual(applicabilityResults.gitDiffApplicability);
ðŸŸ© 53         } catch (e) {
ðŸŸ© 54           throw `${swm} isAutofixed: ${autoFixResult.autoFixSuccess}; hunkByHunkApplicability:${applicabilityResults.hunkByHunkApplicability},gitDiffApplicability:${applicabilityResults.gitDiffApplicability} `;
ðŸŸ© 55         }
ðŸŸ© 56       }
ðŸŸ© 57     }
â¬œ 58     
â¬œ 59     async function checkApplicabilityForSwmFile(swmFile: SwmFile) {
â¬œ 60       const gitDiffApplicability = isSwmApplicable(swmFile);
```
<br/>

# How to debug?

So it's time to dig in, let's run autosync's main flow. For that, you can take one of the existing tests and tweak it.	

<br/>

For example here - we run the main flow for a specific Unit.


<div>    ðŸ“„ src/swimmagic/autofix.spec.ts  </div>

```ts
â¬œ 186        });
â¬œ 187    
â¬œ 188        describe('Update context', () => {
ðŸŸ© 189          test('Update upper context and move down a few lines -> updates accordingly', async () => {
ðŸŸ© 190            state.set('cwd', currentRepoCwd);
ðŸŸ© 191            const UPPER_CONTEXT_UNIT_ID = 'ml5rbhkct0pUSBMLTAhc';
ðŸŸ© 192            const result = await autofix.autoFixUnit(UPPER_CONTEXT_UNIT_ID);
ðŸŸ© 193            expect(result.autoFixSuccess).toBeTruthy();
ðŸŸ© 194            const autoFixedUnit = result.autoFixedSwmFile;
â¬œ 195            const correctCell: SwmCellSnippet = autoFixedUnit.content.filter((cell): boolean => cell.type === 'snippet')[0] as SwmCellSnippet;
â¬œ 196            expect(correctCell.firstLineNumber).toBe(3);
â¬œ 197            expect(correctCell.path).toBe('autoFixTests/updateContext/update_upper_context_only.py');
```
<br/>

Notice that we set the `cwd` to the relevant repo. So there's no need to copy the Unit to the staging database.

<div>    ðŸ“„ src/swimmagic/autofix.spec.ts  </div>

```ts
â¬œ 187    
â¬œ 188        describe('Update context', () => {
â¬œ 189          test('Update upper context and move down a few lines -> updates accordingly', async () => {
ðŸŸ© 190            state.set('cwd', currentRepoCwd);
â¬œ 191            const UPPER_CONTEXT_UNIT_ID = 'ml5rbhkct0pUSBMLTAhc';
â¬œ 192            const result = await autofix.autoFixUnit(UPPER_CONTEXT_UNIT_ID);
â¬œ 193            expect(result.autoFixSuccess).toBeTruthy();
```
<br/>

From here - you can debug the actual flow - use breakpoints and so on ðŸ˜Ž

<br/>

Debugging AutoSync is challenging, but hopefully this document will help you.

Have tips or best practices to share? Please add them here!

<br/>

<br/><br/>

This file was generated by Swimm. [Click here to view it in the app](https://swimm.io/link?l=c3dpbW0lM0ElMkYlMkZyZXBvcyUyRnZlZXp2eEN1enBQclJMTFhXRDJFJTJGZG9jcyUyRnZEaUxMcWZUVlg2akszaG5mZFJh). Timestamp: 2021-04-24T18:52:02.379Z
