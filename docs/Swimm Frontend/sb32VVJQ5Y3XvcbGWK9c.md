---
title: Domain Settings
---

<div align="center">    <br/>    <div>DOC</div>    <h1>Domain Settings</h1>    <br/>  </div>

### Files Used:
ðŸ“„ cloud/firestore.rules

ðŸ“„ src/app/common/mixins/storeModulesWrapper.js

ðŸ“„ cloud/functions/index.js


<br/>

In our Firstore we keep specific domain settings under `/domains` collection.
The domain settings properties:
1.  `isWorkspaceCreationProhibited` - if `true` then users in that email domain are not allowed to create new workspaces. This is useful when clients want to ensure their employees don't create additional workspaces, and make sure they are all within a single workspace assigned for their company.
2.  `isInviteToWorkspaceOutsideDomainProhibited` - if `true` then users in a workspace that is connected to that domain (through `billing_account.domain`) are not allowed to invite users in a different domain. e.g inviting emails which are not in `@myCompany.com` domain will fail. 

<br/>

These are the Firestore rules for `/domains`. The domains will be set by a Firestore admin and can be read only by users in the specific domain.

<div>    ðŸ“„ cloud/firestore.rules  </div>

```rules
â¬œ 43     
ðŸŸ© 44         match /{path=**}/domains/{domain} {
ðŸŸ© 45           // Any writing is forbidden and can only be done by Swimm's team with direct access to the db.
ðŸŸ© 46           allow read: if request.auth.token.email.split('@')[1] == domain;
ðŸŸ© 47         }
â¬œ 48     
```
<br/>

We are fetching the domain settings on app load and store them in the FE store.

<div>    ðŸ“„ src/app/common/mixins/storeModulesWrapper.js  </div>

```js
â¬œ 112        async setDefaultAppData(repoId) {
â¬œ 113          if (this.$route.params.workspaceId) {
â¬œ 114            await this.fetchWorkspace({ workspaceId: this.$route.params.workspaceId });
â¬œ 115          }
â¬œ 116    
ðŸŸ© 117          await this.fetchDomainSettings();
â¬œ 118    
â¬œ 119          const requestedRepoId = repoId || this.$route.params.repoId;
â¬œ 120          const loadResult = await this.loadLocalRepo(requestedRepoId);
```
<br/>

We are blocking workspace creation in the Firestore rules if `isWorkspaceCreationProhibited` is active for the domain.

<div>    ðŸ“„ cloud/firestore.rules  </div>

```rules
â¬œ 52     
ðŸŸ© 53         match /workspaces/{workspace} {
ðŸŸ© 54           allow create: if request.auth != null && !isWorkspaceCreationProhibitedForDomain();
â¬œ 55           allow update: if isUserWorkspaceAdmin(workspace) || (isUserInWorkspace(workspace) && hasOnlyUpdatedInvitesField());
â¬œ 56           allow list,read: if isUserInWorkspace(workspace) || isUserInvitedToResource(resource);
```
<br/>

<div>    ðŸ“„ cloud/firestore.rules  </div>

```rules
ðŸŸ© 98           function isWorkspaceCreationProhibitedForDomain() {
ðŸŸ© 99             let domain = request.auth.token.email.split('@')[1];
ðŸŸ© 100            return exists(/databases/$(database)/documents/domains/$(domain)) && ('isWorkspaceCreationProhibited' in get(/databases/$(database)/documents/domains/$(domain)).data) && get(/databases/$(database)/documents/domains/$(domain)).data.isWorkspaceCreationProhibited;
ðŸŸ© 101          }
```
<br/>

In the `invite` cloud function we block out domain invites if `isInviteToWorkspaceOutsideDomainProhibited` is active on the domain settings.

<div>    ðŸ“„ cloud/functions/index.js  </div>

```js
â¬œ 46             if (billingAccountRef.exists) {
â¬œ 47               usersLimit = billingAccountRef.data().users_limit;
â¬œ 48     
ðŸŸ© 49               // fail invite if prohibited to invite an email with a different domain than the billing account
ðŸŸ© 50               const domain = billingAccountRef.data().domain;
ðŸŸ© 51               if (domain && !data.email.endsWith(`@${domain}`)) {
ðŸŸ© 52                 const domainSettingsRef = await db.collection(`domains`).doc(domain).get();
ðŸŸ© 53                 if (domainSettingsRef.exists) {
ðŸŸ© 54                   if (!!domainSettingsRef.data().isInviteToWorkspaceOutsideDomainProhibited) {
ðŸŸ© 55                     return { status: 'error', code: StatusCodes.FORBIDDEN };
ðŸŸ© 56                   }
ðŸŸ© 57                 }
ðŸŸ© 58               }
â¬œ 59             }
â¬œ 60           }
â¬œ 61     
```
<br/>



<br/>

<br/><br/>

This file was generated by Swimm. [Click here to view it in the app](https://swimm.io/link?l=c3dpbW0lM0ElMkYlMkZyZXBvcyUyRnZlZXp2eEN1enBQclJMTFhXRDJFJTJGZG9jcyUyRnNiMzJWVkpRNVkzWHZjYkdXSzlj). Timestamp: 2021-04-24T18:52:02.335Z
